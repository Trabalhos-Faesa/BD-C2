-- https://neon.com/postgresql/postgresql-tutorial/postgresql-char-varchar-text

DROP TABLE IF EXISTS cliente CASCADE;
DROP TABLE IF EXISTS itens_do_carrinho CASCADE;
DROP TABLE IF EXISTS carrinho_de_compras CASCADE;
DROP TABLE IF EXISTS produto CASCADE;
DROP TABLE IF EXISTS pedido CASCADE;
CREATE TABLE cliente (
    -- id_cliente INT GENERATED BY DEFAULT AS IDENTITY,
    id_cliente INT GENERATED ALWAYS AS IDENTITY,
    email TEXT NOT NULL,
    senha TEXT NOT NULL,
    nome TEXT NOT NULL,
    sobrenome TEXT NOT NULL,
    cpf VARCHAR(11) NOT NULL,
    cep VARCHAR(8) DEFAULT NULL,
    uf VARCHAR(2) DEFAULT NULL,
    cidade TEXT DEFAULT NULL,
    bairro TEXT DEFAULT NULL,
    rua TEXT DEFAULT NULL,
    numero TEXT DEFAULT NULL,
    complemento TEXT DEFAULT NULL,

    CONSTRAINT unique_email UNIQUE (email),
    CONSTRAINT unique_cpf UNIQUE (cpf)
);
-- SELECT * FROM cliente LIMIT 10;

CREATE TABLE produto (
    id_produto INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    nome TEXT NOT NULL,
    descricao TEXT DEFAULT NULL,
    preco NUMERIC(12,2) NOT NULL CHECK (preco >= 0),
    quantidade_estoque INT NOT NULL DEFAULT 0 CHECK (quantidade_estoque >= 0),
    categoria TEXT DEFAULT NULL,
    data_criacao TIMESTAMP DEFAULT NOW()
);

CREATE TABLE carrinho_de_compras (
    id_carrinho INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    id_cliente INT NOT NULL REFERENCES cliente(id_cliente) ON DELETE CASCADE,
    data_criacao TIMESTAMP DEFAULT NOW(),
    status TEXT NOT NULL DEFAULT 'aberto' -- 'aberto' | 'fechado'
);

CREATE TABLE itens_do_carrinho (
    id_carrinho INT NOT NULL REFERENCES carrinho_de_compras(id_carrinho) ON DELETE CASCADE,
    id_produto INT NOT NULL REFERENCES produto(id_produto),
    quantidade INT NOT NULL CHECK (quantidade > 0),
    PRIMARY KEY (id_carrinho, id_produto)
);

CREATE TABLE pedido (
    id_pedido INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    id_cliente INT NOT NULL REFERENCES cliente(id_cliente),
    data_pedido TIMESTAMP DEFAULT NOW(),
    valor_total NUMERIC(14,2) NOT NULL DEFAULT 0,
    status TEXT NOT NULL DEFAULT 'confirmado',
    id_carrinho INT NOT NULL REFERENCES carrinho_de_compras(id_carrinho)
);

CREATE TABLE relatorio (
    id_relatorio INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    id_pedido INT NOT NULL REFERENCES pedido(id_pedido),
    data_geracao TIMESTAMP DEFAULT NOW(),
    conteudo TEXT
);
